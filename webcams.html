<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Coastal Webcams | Salish Sea Live Views</title>

  <meta name="description" content="Live webcam views from coastal locations around the Salish Sea, including White Rock East Beach and Boundary Bay." />
  <meta name="keywords" content="Salish Sea webcams, White Rock East Beach camera, coastal webcams, BC beach webcams, live ocean views, marine webcams, Boundary Bay" />

  <link rel="canonical" href="https://halibutbank.ca/webcams.html" />
  <link rel="stylesheet" href="/assets/css/style-v4.css?v=20251112" />
  <link rel="stylesheet" href="/assets/css/nav-tide-styles-v4.css" />
  <link rel="stylesheet" href="/assets/css/warning-banner-v4.css" />

  <style>
    .webcam-region {
      margin: 2rem auto;
      max-width: 1200px;
      padding: 0 1rem;
    }

    .webcam-region-header {
      background: linear-gradient(to right, #2c5282, #2b6cb0);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px 8px 0 0;
      margin-bottom: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .webcam-region-header:hover {
      background: linear-gradient(to right, #2a4a75, #295fa0);
    }

    .webcam-region-header h2 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .webcam-region-description {
      font-size: 0.9rem;
      margin: 0.5rem 0 0 0;
      opacity: 0.95;
    }

    .webcam-region-toggle-btn {
      display: inline-block;
      margin-right: 0.5rem;
      font-size: 0.9em;
      transition: transform 0.2s;
    }

    .webcam-region.collapsed .webcam-region-toggle-btn {
      transform: rotate(-90deg);
    }

    .webcam-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
      gap: 2rem;
      padding: 2rem 0;
      justify-content: center;
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s;
    }

    .webcam-region.collapsed .webcam-grid {
      max-height: 0;
      padding: 0;
    }

    .webcam-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: box-shadow 0.2s;
      max-width: 100%;
    }

    .webcam-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .webcam-header {
      background: linear-gradient(to right, #004b7c, #005a94);
      color: white;
      padding: 1rem 1.5rem;
    }

    .webcam-header h3 {
      margin: 0 0 0.25rem 0;
      font-size: 1.3rem;
    }

    .webcam-location {
      font-size: 0.9rem;
      opacity: 0.9;
      margin: 0;
    }

    .webcam-image-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      background: #f0f0f0;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .webcam-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
    }

    .slideshow-controls {
      display: none; /* Hidden until slideshow data loads */
      padding: 0.75rem;
      background: #f7fafc;
      border-top: 1px solid #e2e8f0;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .slideshow-nav {
      background: #4299e1;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1.2rem;
      border-radius: 4px;
      transition: background 0.2s, opacity 0.2s;
      min-width: 40px;
    }

    .slideshow-nav:hover:not(:disabled) {
      background: #3182ce;
    }

    .slideshow-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: #cbd5e0;
    }

    .slideshow-dots {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .slideshow-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #cbd5e0;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }

    .slideshow-dot:hover {
      transform: scale(1.2);
    }

    .slideshow-dot.active {
      background: #4299e1;
    }

    .webcam-loading {
      color: #718096;
      font-style: italic;
    }

    .webcam-info {
      padding: 1rem 1.5rem;
      background: #f7fafc;
    }

    .webcam-update-notice {
      font-size: 0.9rem;
      color: #2c5282;
      background: #e6f2ff;
      padding: 0.5rem;
      margin-bottom: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
    }

    .webcam-timestamp {
      font-size: 0.85rem;
      color: #4a5568;
      margin-bottom: 0.5rem;
    }

    .slideshow-age-indicator {
      font-size: 0.8rem;
      color: #718096;
      font-style: italic;
      margin-top: 0.25rem;
    }

    .webcam-source {
      font-size: 0.85rem;
      color: #4a5568;
    }

    .webcam-source a {
      color: #4299e1;
      text-decoration: none;
    }

    .webcam-source a:hover {
      text-decoration: underline;
    }

    .marine-conditions-banner {
      background: white;
      padding: 1.25rem 1.5rem;
      margin: 0 auto 1.5rem auto;
      max-width: 1200px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .marine-conditions-banner h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c5282;
    }

    .conditions-stack {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .condition-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .condition-row:last-child {
      border-bottom: none;
    }

    .condition-station-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: #4a5568;
      min-width: 160px;
      flex-shrink: 0;
    }

    .condition-data {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      flex: 1;
    }

    .condition-timestamp {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-left: auto;
      white-space: nowrap;
    }

    .condition-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: 0.5rem;
    }

    .condition-link {
      font-size: 0.85rem;
      color: #0077be;
      text-decoration: none;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      transition: background 0.2s;
    }

    .condition-link:hover {
      background: #e6f2ff;
      text-decoration: underline;
    }

    .condition-wind,
    .condition-waves {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .condition-wind-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
    }

    .condition-wind-details {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
    }

    .wind-cardinal {
      font-weight: 600;
      color: #2c5282;
    }

    .wind-degrees {
      color: #718096;
      font-size: 0.9rem;
    }

    .wind-speed {
      font-weight: 600;
      color: #2c5282;
    }

    .wind-gust {
      color: #718096;
    }

    .wave-icon {
      font-size: 1.1rem;
    }

    .wave-details {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
    }

    .wave-height {
      font-weight: 600;
      color: #2c5282;
    }

    .wave-period {
      color: #718096;
    }

    @media (max-width: 768px) {
      .condition-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .condition-station-name {
        min-width: auto;
      }
    }

    .refresh-button {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: #4299e1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      transition: background 0.2s;
    }

    .refresh-button:hover {
      background: #3182ce;
    }

    .webcam-error {
      padding: 1rem;
      background: #fff5f5;
      color: #c53030;
      border-radius: 4px;
      margin: 1rem;
      text-align: center;
    }

    /* Mobile and tablet responsive */
    @media (max-width: 1024px) {
      .webcam-grid {
        grid-template-columns: 1fr;
        padding: 0 1rem;
      }
    }

    @media (max-width: 768px) {
      .webcam-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 0 0.5rem;
      }

      .webcam-image-container {
        min-height: 200px;
      }
    }

    @media (max-width: 550px) {
      .webcam-grid {
        grid-template-columns: 1fr;
        padding: 0 0.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Warning banners container -->
  <div hx-get="/components/warning-banner.html?v=1" hx-trigger="load" hx-swap="outerHTML swap:0ms settle:0ms"></div>

  <div hx-get="/components/nav.html?v=1" hx-trigger="load" hx-swap="outerHTML swap:0ms settle:0ms" style="min-height: 60px;"></div>

  <div hx-get="/components/header-webcams.html?v=1" hx-trigger="load" hx-swap="outerHTML swap:0ms settle:0ms" style="min-height: 80px;"></div>

  <div hx-get="/components/tagline-webcams.html?v=1" hx-trigger="load" hx-swap="outerHTML swap:0ms settle:0ms" style="min-height: 40px;"></div>

  <div class="container">
    <section style="background: #edf2f7; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
      <h2 style="margin-top: 0; color: #2c5282; font-size: 1.3rem;">About Coastal Webcams</h2>
      <p style="margin-bottom: 0.5rem;">
        Live and near-live views from coastal webcams around the Salish Sea.
        Images are updated every 10 minutes to provide current visual conditions for beaches, piers, and marine areas.
      </p>
      <p style="margin-bottom: 0.5rem;">
        <strong>Important:</strong> Due to YouTube livestream latency, still images are delayed by 6-20 minutes from real-time.
        For current conditions, click "View Source" to watch the live stream directly.
      </p>
      <p style="margin: 0;">
        <strong>Note:</strong> Check the timestamp on each image for exact capture time.
      </p>
    </section>

    <div id="webcams-container">
      <!-- Webcam regions will be loaded here -->
    </div>
  </div>

  <!-- About Section -->
  <div hx-get="/components/about-generic.html?v=1" hx-trigger="load" hx-swap="outerHTML"></div>

  <!-- Navigation (Bottom) -->
  <div hx-get="/components/nav.html?v=1" hx-trigger="load" hx-swap="outerHTML"></div>

  <div hx-get="/components/footer.html?v=1" hx-trigger="load" hx-swap="outerHTML"></div>

  <script src="/assets/js/warning-banner.js"></script>
  <script>
    // Webcam configuration with regional grouping
    const webcamRegions = {
      'salish_sea_south': {
        name: 'Salish Sea - South (White Rock & Boundary Bay)',
        description: 'Webcams covering White Rock East Beach and Boundary Bay area with local marine conditions'
      },
      'west_coast_vi': {
        name: 'West Coast Vancouver Island (Tofino)',
        description: 'Webcams covering the Pacific Ocean coast near Tofino, including popular surf spots'
      }
    };

    const webcams = [
      {
        id: 'whiterock',
        region: 'salish_sea_south',
        name: 'White Rock East Beach',
        location: 'White Rock, BC',
        dataUrl: '/data/wrcam/latest.json',
        imageUrl: '/data/wrcam/latest.jpg',
        slideshowUrl: '/data/wrcam/slideshow_manifest.json',
        slideshowPath: '/data/wrcam/',
        streamDelay: 6,  // minutes
        conditions: [
          {
            label: 'White Rock East Beach',
            customStation: 'whiterock_pier',
            fields: ['wind_speed_only']
          },
          {
            label: 'Crescent Pile',
            buoyStation: 'CRPILE',
            fields: ['wind', 'waves']
          }
        ]
      },
      {
        id: 'boundarybay',
        region: 'salish_sea_south',
        name: 'Boundary Bay',
        location: 'Boundary Bay, BC',
        dataUrl: '/data/bbcam/latest.json',
        imageUrl: '/data/bbcam/latest.jpg',
        slideshowUrl: '/data/bbcam/slideshow_manifest.json',
        slideshowPath: '/data/bbcam/',
        streamDelay: 20,  // minutes
        conditions: [
          {
            label: 'White Rock East Beach',
            customStation: 'whiterock_pier',
            fields: ['wind_speed_only']
          },
          {
            label: 'Crescent Pile',
            buoyStation: 'CRPILE',
            fields: ['wind', 'waves']
          }
        ]
      },
      {
        id: 'coxbay',
        region: 'west_coast_vi',
        name: 'Cox Bay',
        location: 'Tofino, BC',
        dataUrl: '/data/coxbay/latest.json',
        imageUrl: '/data/coxbay/latest.jpg',
        slideshowUrl: '/data/coxbay/slideshow_manifest.json',
        slideshowPath: '/data/coxbay/',
        streamDelay: 20,  // minutes
        conditions: []  // No local marine data available for West Coast yet
      }
    ];

    // Format timestamp for display (24-hour format)
    function formatTimestamp(isoString) {
      const date = new Date(isoString);
      const options = {
        timeZone: 'America/Vancouver',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
        timeZoneName: 'short'
      };
      return date.toLocaleString('en-US', options);
    }

    // Format short timestamp for conditions display
    function formatShortTimestamp(isoString) {
      const date = new Date(isoString);
      const options = {
        timeZone: 'America/Vancouver',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      };
      return date.toLocaleString('en-US', options);
    }

    // Fetch marine data (buoy, wind, and custom stations)
    let cachedMarineData = null;
    async function fetchMarineData() {
      if (cachedMarineData) return cachedMarineData;

      try {
        const [buoyResponse, windResponse, whiterockResponse] = await Promise.all([
          fetch('/data/latest_buoy_v2.json'),
          fetch('/data/latest_wind.json'),
          fetch('/data/whiterock_weather.json')
        ]);

        const buoyData = buoyResponse.ok ? await buoyResponse.json() : {};
        const windData = windResponse.ok ? await windResponse.json() : {};
        const whiterockData = whiterockResponse.ok ? await whiterockResponse.json() : null;

        cachedMarineData = {
          buoy: buoyData,
          wind: windData,
          custom: {
            whiterock_pier: whiterockData
          }
        };
        return cachedMarineData;
      } catch (error) {
        console.error('Failed to fetch marine data:', error);
        return { buoy: {}, wind: {}, custom: {} };
      }
    }

    // Create wind direction arrow SVG
    function createWindArrow(degrees) {
      // Arrow points where wind is blowing TO (meteorological convention)
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '20');
      svg.setAttribute('height', '20');
      svg.setAttribute('viewBox', '-6 -10 12 24');
      svg.style.transform = `rotate(${degrees}deg)`;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M0,12 L-5,-8 L0,-5 L5,-8 Z');
      path.setAttribute('fill', '#dc2626');
      path.setAttribute('stroke', '#dc2626');
      path.setAttribute('stroke-width', '1.5');

      svg.appendChild(path);
      return svg;
    }

    // Create marine conditions banner (before webcam cards)
    function createConditionsBanner(marineData) {
      if (!marineData) return null;

      const banner = document.createElement('div');
      banner.className = 'marine-conditions-banner';
      banner.id = 'marine-conditions-banner';

      const title = document.createElement('h3');
      title.textContent = 'Current Marine Conditions';
      banner.appendChild(title);

      const stack = document.createElement('div');
      stack.className = 'conditions-stack';

      // White Rock East Beach (on-shore wind)
      const whiterockData = marineData.custom?.whiterock_pier;
      if (whiterockData && !whiterockData.stale && whiterockData.wind_speed !== null) {
        const row = document.createElement('div');
        row.className = 'condition-row';

        const stationName = document.createElement('div');
        stationName.className = 'condition-station-name';
        stationName.textContent = 'White Rock East Beach';
        row.appendChild(stationName);

        const dataDiv = document.createElement('div');
        dataDiv.className = 'condition-data';

        const windDiv = document.createElement('div');
        windDiv.className = 'condition-wind';

        const arrow = document.createElement('span');
        arrow.className = 'condition-wind-arrow';
        arrow.appendChild(createWindArrow(whiterockData.wind_direction));
        windDiv.appendChild(arrow);

        const windDetails = document.createElement('div');
        windDetails.className = 'condition-wind-details';
        windDetails.innerHTML = `
          <span class="wind-cardinal">${whiterockData.wind_direction_cardinal || ''}</span>
          <span class="wind-degrees">(${Math.round(whiterockData.wind_direction)}Â°)</span>
          <span class="wind-speed">${whiterockData.wind_speed.toFixed(0)}</span>
          ${whiterockData.wind_gust ? `<span class="wind-gust">G ${whiterockData.wind_gust.toFixed(0)}</span>` : ''}
          <span class="wind-gust">kt</span>
        `;
        windDiv.appendChild(windDetails);
        dataDiv.appendChild(windDiv);

        // Timestamp
        if (whiterockData.observation_time) {
          const timestamp = document.createElement('div');
          timestamp.className = 'condition-timestamp';
          timestamp.textContent = formatShortTimestamp(whiterockData.observation_time);
          dataDiv.appendChild(timestamp);
        }

        // Action links
        const actions = document.createElement('div');
        actions.className = 'condition-actions';
        actions.innerHTML = `
          <a href="https://maps.whiterockcity.ca/weather/" target="_blank" class="condition-link">View Data</a>
        `;
        dataDiv.appendChild(actions);

        row.appendChild(dataDiv);
        stack.appendChild(row);
      }

      // Crescent Pile (offshore wind + waves)
      const crpileData = marineData.buoy?.CRPILE;
      if (crpileData && !crpileData.stale) {
        const row = document.createElement('div');
        row.className = 'condition-row';

        const stationName = document.createElement('div');
        stationName.className = 'condition-station-name';
        stationName.textContent = 'Crescent Pile';
        row.appendChild(stationName);

        const dataDiv = document.createElement('div');
        dataDiv.className = 'condition-data';

        // Wind
        if (crpileData.wind_speed !== null && crpileData.wind_direction !== null) {
          const windDiv = document.createElement('div');
          windDiv.className = 'condition-wind';

          const arrow = document.createElement('span');
          arrow.className = 'condition-wind-arrow';
          arrow.appendChild(createWindArrow(crpileData.wind_direction));
          windDiv.appendChild(arrow);

          const windDetails = document.createElement('div');
          windDetails.className = 'condition-wind-details';
          windDetails.innerHTML = `
            <span class="wind-cardinal">${crpileData.wind_direction_cardinal || ''}</span>
            <span class="wind-degrees">(${Math.round(crpileData.wind_direction)}Â°)</span>
            <span class="wind-speed">${crpileData.wind_speed.toFixed(0)}</span>
            ${crpileData.wind_gust ? `<span class="wind-gust">G ${crpileData.wind_gust.toFixed(0)}</span>` : ''}
            <span class="wind-gust">kt</span>
          `;
          windDiv.appendChild(windDetails);
          dataDiv.appendChild(windDiv);
        }

        // Waves
        if (crpileData.wave_height_sig !== null && crpileData.wave_period_avg !== null) {
          const waveDiv = document.createElement('div');
          waveDiv.className = 'condition-waves';
          waveDiv.innerHTML = `
            <span class="wave-icon">ðŸŒŠ</span>
            <div class="wave-details">
              <span class="wave-height">${crpileData.wave_height_sig.toFixed(2)}m</span>
              <span class="wave-period">@ ${crpileData.wave_period_avg.toFixed(1)}s</span>
            </div>
          `;
          dataDiv.appendChild(waveDiv);
        }

        // Timestamp
        if (crpileData.observation_time) {
          const timestamp = document.createElement('div');
          timestamp.className = 'condition-timestamp';
          timestamp.textContent = formatShortTimestamp(crpileData.observation_time);
          dataDiv.appendChild(timestamp);
        }

        // Action links
        const actions = document.createElement('div');
        actions.className = 'condition-actions';
        actions.innerHTML = `
          <a href="/charts.html#CRPILE" class="condition-link">Show on Map</a>
          <a href="/charts.html?station=CRPILE" class="condition-link">View Charts</a>
        `;
        dataDiv.appendChild(actions);

        row.appendChild(dataDiv);
        stack.appendChild(row);
      }

      banner.appendChild(stack);

      // Only return if we have any rows
      return stack.children.length > 0 ? banner : null;
    }

    // Slideshow state (per webcam)
    const slideshowState = {};

    // Create webcam card
    async function createWebcamCard(webcam, metadata) {
      const card = document.createElement('div');
      card.className = 'webcam-card';
      card.dataset.webcamId = webcam.id;

      // Header
      const header = document.createElement('div');
      header.className = 'webcam-header';

      const title = document.createElement('h3');
      title.textContent = webcam.name;

      const location = document.createElement('p');
      location.className = 'webcam-location';
      location.textContent = webcam.location;

      header.appendChild(title);
      header.appendChild(location);
      card.appendChild(header);

      // Image container
      const imageContainer = document.createElement('div');
      imageContainer.className = 'webcam-image-container';

      const image = document.createElement('img');
      image.className = 'webcam-image';
      image.src = webcam.imageUrl + '?t=' + Date.now();
      image.alt = webcam.name + ' webcam view';
      image.loading = 'lazy';

      imageContainer.appendChild(image);
      card.appendChild(imageContainer);

      // Slideshow controls container (below image)
      const controlsContainer = document.createElement('div');
      controlsContainer.className = 'slideshow-controls';

      // Previous button (shows older images)
      const prevBtn = document.createElement('button');
      prevBtn.className = 'slideshow-nav prev';
      prevBtn.innerHTML = 'â€¹';
      prevBtn.onclick = () => navigateSlideshow(webcam.id, 1); // +1 = older (higher index)

      // Dots container
      const dotsContainer = document.createElement('div');
      dotsContainer.className = 'slideshow-dots';

      // Next button (shows newer images)
      const nextBtn = document.createElement('button');
      nextBtn.className = 'slideshow-nav next';
      nextBtn.innerHTML = 'â€º';
      nextBtn.onclick = () => navigateSlideshow(webcam.id, -1); // -1 = newer (lower index)

      controlsContainer.appendChild(prevBtn);
      controlsContainer.appendChild(dotsContainer);
      controlsContainer.appendChild(nextBtn);
      card.appendChild(controlsContainer);

      // Load slideshow data
      loadSlideshow(webcam);

      // Info section
      const info = document.createElement('div');
      info.className = 'webcam-info';

      // Update notice with delay info
      const updateNotice = document.createElement('div');
      updateNotice.className = 'webcam-update-notice';
      updateNotice.textContent = `Updated every 10 minutes â€¢ ~${webcam.streamDelay} min stream delay`;
      info.appendChild(updateNotice);

      if (metadata) {
        const timestamp = document.createElement('div');
        timestamp.className = 'webcam-timestamp';
        timestamp.textContent = 'Last updated: ' + formatTimestamp(metadata.timestamp);
        info.appendChild(timestamp);

        if (metadata.source || metadata.url) {
          const source = document.createElement('div');
          source.className = 'webcam-source';

          if (metadata.url) {
            const link = document.createElement('a');
            link.href = metadata.url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = metadata.source || 'View Source';
            source.appendChild(document.createTextNode('Source: '));
            source.appendChild(link);
          } else {
            source.textContent = 'Source: ' + metadata.source;
          }

          info.appendChild(source);
        }

        // Refresh button
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'refresh-button';
        refreshBtn.textContent = 'Refresh Image';
        refreshBtn.onclick = async () => {
          image.src = webcam.imageUrl + '?t=' + Date.now();
          loadWebcamMetadata(webcam, card);

          // Reset slideshow to newest image and update dots
          const state = slideshowState[webcam.id];
          if (state) {
            state.currentIndex = 0;
            updateSlideshowDisplay(webcam.id);
          }

          // Refresh marine data banner
          cachedMarineData = null;
          const freshMarineData = await fetchMarineData();
          if (freshMarineData) {
            const existingBanner = document.getElementById('marine-conditions-banner');
            const newBanner = createConditionsBanner(freshMarineData);

            if (existingBanner && newBanner) {
              existingBanner.replaceWith(newBanner);
            } else if (!existingBanner && newBanner) {
              const container = document.getElementById('webcams-container');
              container.parentNode.insertBefore(newBanner, container);
            }
          }
        };
        info.appendChild(refreshBtn);
      }

      card.appendChild(info);
      return card;
    }

    // Load metadata for a webcam
    async function loadWebcamMetadata(webcam, card) {
      try {
        const response = await fetch(webcam.dataUrl);
        const metadata = await response.json();

        // Update timestamp if card exists
        if (card) {
          const timestampEl = card.querySelector('.webcam-timestamp');
          if (timestampEl) {
            timestampEl.textContent = 'Last updated: ' + formatTimestamp(metadata.timestamp);
          }
        }

        return metadata;
      } catch (error) {
        console.error('Failed to load metadata for ' + webcam.name + ':', error);
        return null;
      }
    }

    // Load all webcams grouped by region
    async function loadWebcams() {
      const container = document.getElementById('webcams-container');

      if (webcams.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">No webcams currently available.</p>';
        return;
      }

      container.innerHTML = '';

      // Fetch marine data once
      const marineData = await fetchMarineData();

      // Group webcams by region
      const groupedWebcams = {};
      webcams.forEach(webcam => {
        const region = webcam.region || 'other';
        if (!groupedWebcams[region]) {
          groupedWebcams[region] = [];
        }
        groupedWebcams[region].push(webcam);
      });

      // Create and insert conditions banner before webcam regions
      if (marineData) {
        const banner = createConditionsBanner(marineData);
        if (banner) {
          container.parentNode.insertBefore(banner, container);
        }
      }

      // Render each region
      for (const [regionKey, regionWebcams] of Object.entries(groupedWebcams)) {
        const regionInfo = webcamRegions[regionKey];

        // Create region container
        const regionContainer = document.createElement('div');
        regionContainer.className = 'webcam-region';

        // Region header
        if (regionInfo) {
          const regionHeader = document.createElement('div');
          regionHeader.className = 'webcam-region-header';

          const webcamCount = regionWebcams.length;
          const countText = `${webcamCount} webcam${webcamCount !== 1 ? 's' : ''}`;

          regionHeader.innerHTML = `
            <h2><span class="webcam-region-toggle-btn">â–¼</span>${regionInfo.name} <span style="font-size: 0.8em; font-weight: normal; opacity: 0.8;">(${countText})</span></h2>
            <p class="webcam-region-description">${regionInfo.description}</p>
          `;

          // Add click handler to toggle collapse
          regionHeader.addEventListener('click', () => {
            regionContainer.classList.toggle('collapsed');
          });

          regionContainer.appendChild(regionHeader);
        }

        // Webcam grid for this region
        const grid = document.createElement('div');
        grid.className = 'webcam-grid';

        for (const webcam of regionWebcams) {
          try {
            const metadata = await loadWebcamMetadata(webcam);
            const card = await createWebcamCard(webcam, metadata);
            grid.appendChild(card);
          } catch (error) {
            console.error('Failed to load webcam ' + webcam.name + ':', error);

            const errorCard = document.createElement('div');
            errorCard.className = 'webcam-card';
            errorCard.innerHTML = `
              <div class="webcam-header">
                <h3>${webcam.name}</h3>
                <p class="webcam-location">${webcam.location}</p>
              </div>
              <div class="webcam-error">
                Failed to load webcam data. Please try again later.
              </div>
            `;
            grid.appendChild(errorCard);
          }
        }

        regionContainer.appendChild(grid);
        container.appendChild(regionContainer);
      }
    }

    // Load slideshow manifest and setup navigation
    async function loadSlideshow(webcam) {
      try {
        const response = await fetch(webcam.slideshowUrl + '?t=' + Date.now());
        if (!response.ok) {
          console.warn('Slideshow not available for ' + webcam.name);
          return;
        }

        const manifest = await response.json();
        if (!manifest || manifest.length === 0) {
          console.warn('No slideshow images for ' + webcam.name);
          return;
        }

        // Store slideshow state
        slideshowState[webcam.id] = {
          images: manifest,
          currentIndex: 0, // Start with newest image
          basePath: webcam.slideshowPath
        };

        // Show navigation controls
        const card = document.querySelector(`[data-webcam-id="${webcam.id}"]`);
        if (card && manifest.length > 1) {
          const controlsContainer = card.querySelector('.slideshow-controls');
          const dotsContainer = card.querySelector('.slideshow-dots');

          controlsContainer.style.display = 'flex';

          // Clear existing dots before creating new ones (prevents duplicates on refresh)
          dotsContainer.innerHTML = '';

          // Create dots in reverse order (rightmost = newest)
          manifest.slice().reverse().forEach((img, reverseIndex) => {
            const actualIndex = manifest.length - 1 - reverseIndex;
            const dot = document.createElement('div');
            dot.className = 'slideshow-dot' + (actualIndex === 0 ? ' active' : '');
            dot.dataset.index = actualIndex;
            dot.onclick = () => goToSlide(webcam.id, actualIndex);
            dotsContainer.appendChild(dot);
          });
        }

      } catch (error) {
        console.error('Failed to load slideshow for ' + webcam.name + ':', error);
      }
    }

    // Navigate slideshow (no looping)
    function navigateSlideshow(webcamId, direction) {
      const state = slideshowState[webcamId];
      if (!state || !state.images) return;

      const newIndex = state.currentIndex + direction;

      // Don't allow looping - clamp to valid range
      if (newIndex < 0 || newIndex >= state.images.length) return;

      state.currentIndex = newIndex;
      updateSlideshowDisplay(webcamId);
    }

    // Go to specific slide
    function goToSlide(webcamId, index) {
      const state = slideshowState[webcamId];
      if (!state || !state.images) return;

      state.currentIndex = index;
      updateSlideshowDisplay(webcamId);
    }

    // Update slideshow display
    function updateSlideshowDisplay(webcamId) {
      const state = slideshowState[webcamId];
      if (!state) return;

      const card = document.querySelector(`[data-webcam-id="${webcamId}"]`);
      if (!card) return;

      const image = card.querySelector('.webcam-image');
      const currentImage = state.images[state.currentIndex];

      // Update image src
      image.src = state.basePath + currentImage.path + '?t=' + Date.now();

      // Update timestamp
      const timestamp = card.querySelector('.webcam-timestamp');
      if (timestamp) {
        const capturedTime = new Date(currentImage.timestamp);
        timestamp.textContent = 'Captured: ' + formatTimestamp(currentImage.timestamp);

        // Add age indicator if not the latest image
        let ageIndicator = card.querySelector('.slideshow-age-indicator');
        if (state.currentIndex > 0) {
          const minutesAgo = state.currentIndex * 10; // Images are 10 minutes apart
          if (!ageIndicator) {
            ageIndicator = document.createElement('div');
            ageIndicator.className = 'slideshow-age-indicator';
            timestamp.parentNode.insertBefore(ageIndicator, timestamp.nextSibling);
          }
          ageIndicator.textContent = `(${minutesAgo} minutes ago)`;
        } else if (ageIndicator) {
          ageIndicator.remove();
        }
      }

      // Update navigation buttons (disable at ends, no looping)
      const prevBtn = card.querySelector('.slideshow-nav.prev');
      const nextBtn = card.querySelector('.slideshow-nav.next');

      // At latest (index 0): can't go newer (right), can go older (left)
      // At oldest (max index): can't go older (left), can go newer (right)
      if (prevBtn) prevBtn.disabled = state.currentIndex === state.images.length - 1; // Disable left at oldest
      if (nextBtn) nextBtn.disabled = state.currentIndex === 0; // Disable right at newest

      // Update dots (dots are in reverse order, so match by data-index)
      const dots = card.querySelectorAll('.slideshow-dot');
      dots.forEach((dot) => {
        const dotIndex = parseInt(dot.dataset.index);
        dot.classList.toggle('active', dotIndex === state.currentIndex);
      });
    }

    // Auto-refresh webcams every 5 minutes (up to 30 minutes, then stop)
    function startAutoRefresh() {
      const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
      const MAX_REFRESH_TIME = 30 * 60 * 1000; // 30 minutes
      const startTime = Date.now();
      let refreshCount = 0;

      const intervalId = setInterval(() => {
        const elapsed = Date.now() - startTime;

        // Stop auto-refresh after 30 minutes
        if (elapsed >= MAX_REFRESH_TIME) {
          clearInterval(intervalId);
          console.log('Auto-refresh stopped after 30 minutes. Refresh page to resume.');
          showRefreshNotice();
          return;
        }

        refreshCount++;
        console.log(`Auto-refreshing webcam images... (${refreshCount}/6)`);

        // Clear marine data cache to force refresh
        cachedMarineData = null;

        // Reload marine data and update all webcam cards
        fetchMarineData().then(marineData => {
          webcams.forEach(webcam => {
            const card = document.querySelector(`[data-webcam-id="${webcam.id}"]`);
            if (!card) return;

            // Only refresh image if viewing the latest (index 0)
            const state = slideshowState[webcam.id];
            if (!state || state.currentIndex === 0) {
              const image = card.querySelector('.webcam-image');
              image.src = webcam.imageUrl + '?t=' + Date.now();
            }

            // Update conditions banner (only once, not per webcam)
            if (marineData && webcam === webcams[0]) {
              const existingBanner = document.getElementById('marine-conditions-banner');
              const newBanner = createConditionsBanner(marineData);

              if (existingBanner && newBanner) {
                existingBanner.replaceWith(newBanner);
              } else if (!existingBanner && newBanner) {
                const container = document.getElementById('webcams-container');
                container.parentNode.insertBefore(newBanner, container);
              }
            }

            // Reload slideshow manifest
            loadSlideshow(webcam);
            loadWebcamMetadata(webcam, card);
          });
        });
      }, REFRESH_INTERVAL);
    }

    // Show notice when auto-refresh stops
    function showRefreshNotice() {
      const notice = document.createElement('div');
      notice.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #2c5282;
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 0.95rem;
        text-align: center;
      `;
      notice.innerHTML = `
        Auto-refresh stopped after 30 minutes
        <button onclick="location.reload()" style="
          margin-left: 1rem;
          padding: 0.5rem 1rem;
          background: white;
          color: #2c5282;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: 600;
        ">Refresh Page</button>
      `;
      document.body.appendChild(notice);

      // Auto-hide notice after 10 seconds
      setTimeout(() => {
        notice.style.transition = 'opacity 0.5s';
        notice.style.opacity = '0';
        setTimeout(() => notice.remove(), 500);
      }, 10000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadWebcams();
      startAutoRefresh();
    });

    // Also load immediately if DOM is already ready
    if (document.readyState === 'loading') {
      // Already set up listener above
    } else {
      loadWebcams();
      startAutoRefresh();
    }
  </script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</body>
</html>
